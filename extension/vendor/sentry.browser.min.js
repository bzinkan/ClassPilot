(() => {
  if (globalThis.Sentry) {
    return;
  }

  const state = {
    options: null,
    dsn: null,
  };

  function parseDsn(dsn) {
    try {
      const parsed = new URL(dsn);
      const projectId = parsed.pathname.replace('/', '');
      return {
        protocol: parsed.protocol,
        host: parsed.host,
        key: parsed.username,
        projectId,
      };
    } catch (error) {
      return null;
    }
  }

  function uuid4() {
    return 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'.replace(/x/g, () =>
      Math.floor(Math.random() * 16).toString(16)
    );
  }

  function buildStacktrace(error) {
    if (!error || !error.stack) return undefined;
    const frames = error.stack
      .split('\n')
      .slice(0, 20)
      .map((line) => ({ filename: line.trim() }))
      .reverse();
    return { frames };
  }

  function buildEvent(error) {
    const event = {
      event_id: uuid4(),
      timestamp: new Date().toISOString(),
      platform: 'javascript',
      level: 'error',
      exception: {
        values: [
          {
            type: error?.name || 'Error',
            value: error?.message || String(error),
            stacktrace: buildStacktrace(error),
          },
        ],
      },
    };
    return event;
  }

  async function sendEvent(event) {
    if (!state.dsn) {
      return;
    }

    const { protocol, host, key, projectId } = state.dsn;
    if (!protocol || !host || !key || !projectId) {
      return;
    }

    const url = `${protocol}//${host}/api/${projectId}/store/`;
    const headers = {
      'Content-Type': 'application/json',
      'X-Sentry-Auth': `Sentry sentry_version=7, sentry_key=${key}, sentry_client=classpilot-extension`,
    };

    try {
      await fetch(url, {
        method: 'POST',
        headers,
        body: JSON.stringify(event),
      });
    } catch (error) {
      console.warn('[Sentry] Failed to send event:', error);
    }
  }

  globalThis.Sentry = {
    init(options = {}) {
      state.options = options;
      state.dsn = options.dsn ? parseDsn(options.dsn) : null;
    },
    captureException(error) {
      if (!state.options?.dsn) {
        return;
      }
      let event = buildEvent(error);
      if (typeof state.options.beforeSend === 'function') {
        const result = state.options.beforeSend({ ...event });
        if (result === null) {
          return;
        }
        event = result || event;
      }
      sendEvent(event);
    },
  };
})();
